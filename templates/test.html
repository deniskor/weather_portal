{% extends 'base.html' %}

{% block content %}
    <div id="filter">
        <select id='select_city' style='width: 200px;' class="select2">
        </select>
        <input data-provide="datepicker">
        {#        <div class="form-group row">#}
        {#            <label for="example-date-input" class="col-2 col-form-label">Date</label>#}
        {#            <div class="col-10">#}
        {#                <input class="form-control" type="date" id="example-date-input">#}
        {#            </div>#}
        {#        </div>#}
    </div>

    <div id="res">
    </div>
    <div id='pagination'>
    </div>

{% endblock %}

{% block script %}
    <script>
        $("#results_page").addClass("active");
        let urlParams = new URLSearchParams(window.location.search);
        let current_page = 1;
        console.log(current_page);
        let page_cnt = 0;
        let selected_option = null;

        $('.datepicker').datepicker({
            format: 'mm/dd/yy',
            startDate: '-3d'
        });
        $("#select_city").select2({
            placeholder: "City",
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url 'get_city' %}',
                type: 'GET',
                dataType: 'json',
                quietMillis: 500,
                data: function (term, page) {
                    return {
                        q: term,
                    };
                },
                processResults: function (data) {
                    return {
                        results: $.map(data.items, function (val, id) {
                            return {id: id, text: val}
                        })
                    };
                },
            }
        });

        $("#select_city").on('select2:select', function (event) {
            selected_option = $(event.currentTarget).find("option:selected").val();
            urlParams.set('city', selected_option);
            urlParams.set('page', 1);
            get_data();
            console.log(selected_option);
        });
        $("#select_city").on('select2:unselecting', function (event) {
            selected_option = null;
            urlParams.delete('city');
            urlParams.set('page', 1);
            get_data();
            console.log(selected_option);
        });

        function render_weather(data) {
            let el = $('#res');
            el.empty();
            let render_str = `<div class="card-body">
            <div class="d-flex flex-wrap justify-content-center">`;

            data.forEach(function (element) {
                render_str += `
                <div class="card border-secondary text-center" style="width: 14rem;">
                        <div class="card-header">
                            <h3>${element['temp']}â„ƒ</h3>
                            ${element['time']}<br>
                            <strong>${element['city']}</strong>
                        </div>
                        <div class="card-body text-secondary" onclick="click_pag(1)">
                            Clouds ${element['clouds']}% <br>
                            Wind ${element['wind']}m/s.<br>
                        </div>
                </div>`
            });

            render_str += `</div> </div>`;
            el.append(render_str)
        }

        function click_pag(page) {
            urlParams.set("page", page);
            console.log(urlParams.toString());
            get_data();
        }

        function render_paginator() {
            let el = $('#pagination');
            el.empty();

            let print_begin = false;
            let print_end = false;

            let start_range = 1;
            let end_range = page_cnt;

            if (current_page > 6) {
                print_begin = true;
                start_range = current_page - 5;
            }
            if (page_cnt - current_page > 6) {
                print_end = true;
                end_range = current_page + 5;
            }

            let render_str = `
                <div class="pagination justify-content-center">
                    <ul class="pagination justify-content-center">`;

            if (print_begin) {
                render_str += `
                <li class="page-item">
                    <span class="page-link" onclick="click_pag(1)">1</span>
                </li>
                <li class="page-item disable">
                    <a class="page-link">...</a>
                </li>`;
            }
            for (let i = start_range; i <= end_range; i++) {
                let active = i === current_page ? 'active' : '';
                render_str += `
                    <li class="page-item ${active}">
                        <span class="page-link" onclick="click_pag(${i})">${i}</span>
                    </li>`;
            }
            if (print_end) {
                render_str += `
                <li class="page-item disable">
                    <a class="page-link">...</a>
                </li>
                <li class="page-item">
                    <span class="page-link" onclick="click_pag(${page_cnt})">${page_cnt}</span>
                </li>`;
            }
            render_str += '</div></div>';
            console.log(start_range, end_range, print_begin, print_end);
            el.append(render_str)
        }

        function get_data() {
            let url = `{% url 'results' %}?${urlParams.toString()}`;
            $.ajax({
                url: url,
                type: 'GET',
                success: function (data) {
                    console.log(data);
                    if (data['code'] === '404') {
                        $('#res').empty();
                        $('#pagination').empty();
                        $('#res').append(`
                                    <div class="alert alert-danger text-center" role="alert">
                                          ${data['msg'].charAt(0).toUpperCase() + data['msg'].slice(1)}
                                    </div>`);
                    } else {
                        page_cnt = data['page_cnt'];
                        current_page = data['curr_page'];
                        console.log(urlParams.toString());
                        render_paginator();
                        render_weather(data['items']);
                    }
                }
            });
        }

        get_data()
    </script>
{% endblock %}
